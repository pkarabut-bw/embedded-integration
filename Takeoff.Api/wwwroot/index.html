<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/themes/default/style.min.css" rel="stylesheet" />
  <title>Takeoff</title>
  <style>
    body, html { height: 100%; }
    #formPanel { height: calc(100vh - 120px); overflow: auto; }
    #takeoffTree { height: calc(100vh - 120px); overflow: auto; border: 1px solid #ddd; padding: 8px; }
    .table td, .table th { vertical-align: middle; }
    .entity-form { display: none; }
    #spinnerOverlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); display: none; align-items: center; justify-content: center; z-index: 1050; }
    
    /* Custom tree icons */
    #takeoffTree .jstree-icon.jstree-themeicon {
      width: 0;
      margin-right: 0;
      background: none;
    }
    
    #takeoffTree .jstree-anchor {
      font-style: normal;
    }
    
    #takeoffTree .jstree-node.project-node > .jstree-anchor::before {
      content: 'ðŸ“¦ ';
      font-size: 16px;
      margin-right: 4px;
      font-style: normal;
    }
    
    #takeoffTree .jstree-node.condition-node > .jstree-anchor::before {
      content: 'âš™ï¸ ';
      font-size: 16px;
      margin-right: 4px;
      font-style: normal;
    }
    
    #takeoffTree .jstree-node.document-node > .jstree-anchor::before {
      content: 'ðŸ“‹ ';
      font-size: 16px;
      margin-right: 4px;
      font-style: normal;
    }
    
    #takeoffTree .jstree-node.page-node > .jstree-anchor::before {
      content: 'ðŸ“„ ';
      font-size: 16px;
      margin-right: 4px;
      font-style: normal;
    }
    
    #takeoffTree .jstree-node.zone-node > .jstree-anchor::before {
      content: 'ðŸ”² ';
      font-size: 16px;
      margin-right: 4px;
      font-style: normal;
    }
  </style>
</head>
<body>
  <div id="spinnerOverlay">
    <div class="text-center text-white">
      <div class="spinner-border text-light" role="status" style="width:4rem;height:4rem;"></div>
      <div class="mt-2">Working...</div>
    </div>
  </div>

  <div class="container-fluid p-2">
    <div class="d-flex mb-2">
      <div>
        <button id="btnAddCondition" class="btn btn-primary">Add Condition</button>
      </div>
      <div class="ms-auto d-flex align-items-center">
        <select id="projectSelect" class="form-select me-2" style="width:320px;"></select>
        <div id="statusArea" class="text-muted">Status: idle</div>
      </div>
    </div>
    <div class="row g-2">
      <div class="col-6">
        <div id="takeoffTree"></div>
      </div>
      <div class="col-6">
        <div id="formPanel">

          <!-- Condition form -->
          <div id="conditionForm" class="card p-3 entity-form">
            <h5>Condition</h5>
            <div class="mb-2"><label class="form-label">Id</label><input id="cId" class="form-control" readonly /></div>
            <div class="mb-2"><label class="form-label">ProjectId</label><input id="cProjectId" class="form-control" readonly /></div>
            <div class="mb-3">
              <h6>Project Summary (computed)</h6>
              <table class="table table-sm" id="cProjectSummary"><thead><tr><th>Name</th><th>Unit</th><th>Value</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="d-flex">
              <button id="cAddDocument" class="btn btn-primary me-2">Add Document</button>
              <button id="cDeleteCondition" class="btn btn-danger">Delete Condition</button>
            </div>
          </div>

          <!-- Document form -->
          <div id="documentForm" class="card p-3 entity-form">
            <h5>Document</h5>
            <div class="mb-2"><label class="form-label">Document Id</label><input id="dId" class="form-control" readonly /></div>
            <div class="mb-3">
              <h6>Document Summary (computed)</h6>
              <table class="table table-sm" id="dSummary"><thead><tr><th>Name</th><th>Unit</th><th>Value</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="d-flex">
              <button id="dAddPage" class="btn btn-primary me-2">Add Page</button>
              <button id="dDeleteDocument" class="btn btn-danger">Delete Document</button>
            </div>
          </div>

          <!-- Page form -->
          <div id="pageForm" class="card p-3 entity-form">
            <h5>Page</h5>
            <div class="mb-2"><label class="form-label">Page Id</label><input id="pId" class="form-control" readonly /></div>
            <div class="mb-2"><label class="form-label">Page Number</label><input id="pNumber" type="number" class="form-control" readonly /></div>
            <div class="mb-3">
              <h6>Page Summary (computed)</h6>
              <table class="table table-sm" id="pSummary"><thead><tr><th>Name</th><th>Unit</th><th>Value</th></tr></thead><tbody></tbody></table>
            </div>
            <div class="d-flex">
              <button id="pAddZone" class="btn btn-primary me-2">Add Zone</button>
              <button id="pDeletePage" class="btn btn-danger">Delete Page</button>
            </div>
          </div>

          <!-- Zone form -->
          <div id="zoneForm" class="card p-3 entity-form">
            <h5>Zone</h5>
            <div class="mb-2"><label class="form-label">Zone Id</label><input id="zId" class="form-control" readonly /></div>
            <div class="mb-3">
              <h6>Zone Summary (editable)</h6>
              <table class="table table-sm" id="zSummary"><thead><tr><th>Name</th><th>Unit</th><th>Value</th><th></th></tr></thead><tbody></tbody></table>
              <button id="zAddRow" class="btn btn-sm btn-outline-primary">Add Row</button>
            </div>
            <div class="d-flex">
              <button id="zSave" class="btn btn-primary me-2">Save Zone</button>
              <button id="zDelete" class="btn btn-danger">Delete Zone</button>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/jstree.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  (function() {
    'use strict';

    // â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    var currentProjectId = null;
    var sel = { conditionId: null, documentId: null, pageId: null, zoneId: null };
    
    // Client-side ID to number mappings (persisted across renders, never cleared)
    var idToDocumentNumber = {}; // documentId -> number
    var idToPageNumber = {}; // pageId -> number
    var idToZoneNumber = {}; // zoneId -> number
    var nextDocumentNumber = 1;
    var nextPageNumber = 1;
    var nextZoneNumber = 1;

    // â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function setStatus(t) { $('#statusArea').text('Status: ' + t); }
    function showSpinner() { $('#spinnerOverlay').css('display', 'flex'); }
    function hideSpinner() { $('#spinnerOverlay').css('display', 'none'); }

    function api(opts) {
      showSpinner();
      return $.ajax(opts).always(function() { hideSpinner(); });
    }

    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, function(c) {
        return { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[c];
      });
    }

    function qDisplayRow(q) {
      return '<tr><td>' + escapeHtml(q.name) + '</td><td>' + escapeHtml(q.unit) + '</td><td>' + Number(q.value || 0) + '</td></tr>';
    }

    function qInputRow(q) {
      return '<tr>' +
        '<td><input class="form-control q-name" value="' + escapeHtml(q ? q.name : '') + '"/></td>' +
        '<td><input class="form-control q-unit" value="' + escapeHtml(q ? q.unit : '') + '"/></td>' +
        '<td><input type="number" step="any" class="form-control q-value" value="' + Number(q ? q.value : 0) + '"/></td>' +
        '<td><button class="btn btn-sm btn-danger z-remove-row">X</button></td></tr>';
    }

    // â”€â”€ ID to number mapping functions â”€â”€
    function getDocumentNumber(docId) {
      if (!idToDocumentNumber[docId]) {
        idToDocumentNumber[docId] = nextDocumentNumber++;
      }
      return idToDocumentNumber[docId];
    }

    function getPageNumber(pageId) {
      if (!idToPageNumber[pageId]) {
        idToPageNumber[pageId] = nextPageNumber++;
      }
      return idToPageNumber[pageId];
    }

    function getZoneNumber(zoneId) {
      if (!idToZoneNumber[zoneId]) {
        idToZoneNumber[zoneId] = nextZoneNumber++;
      }
      return idToZoneNumber[zoneId];
    }

    // â”€â”€ Forms â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function hideAllForms() { $('.entity-form').hide(); }
    function showConditionForm() { hideAllForms(); $('#conditionForm').show(); }
    function showDocumentForm() { hideAllForms(); $('#documentForm').show(); }
    function showPageForm() { hideAllForms(); $('#pageForm').show(); }
    function showZoneForm() { hideAllForms(); $('#zoneForm').show(); }

    // â”€â”€ Tree â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function renderTree(projectId, data) {
      var nodes = [];
      var pid = 'project-' + projectId;
      nodes.push({ id: pid, parent: '#', text: 'Project', state: { opened: true }, 
        li_attr: { class: 'project-node' } });
      
      // Scan data and assign numbers to any new IDs (but don't clear existing mappings)
      (data || []).forEach(function(cond) {
        (cond.documents || []).forEach(function(doc) {
          getDocumentNumber(doc.id); // Ensure mapping exists
          (doc.pages || []).forEach(function(pg) {
            getPageNumber(pg.id); // Ensure mapping exists
            (pg.takeoffZones || []).forEach(function(z) {
              getZoneNumber(z.id); // Ensure mapping exists
            });
          });
        });
      });
      
      (data || []).forEach(function(cond, condIdx) {
        var cid = 'cond-' + cond.id;
        nodes.push({ id: cid, parent: pid, text: 'Condition ' + (condIdx + 1), state: { opened: true },
          li_attr: { class: 'condition-node' },
          data: { type: 'condition', condition: cond } });
        (cond.documents || []).forEach(function(doc) {
          var docNum = getDocumentNumber(doc.id);
          var did = cid + '-doc-' + doc.id;
          nodes.push({ id: did, parent: cid, text: 'Document ' + docNum, state: { opened: true },
            li_attr: { class: 'document-node' },
            data: { type: 'document', document: doc, conditionId: cond.id } });
          (doc.pages || []).forEach(function(pg) {
            var pgNum = getPageNumber(pg.id);
            var pgid = did + '-page-' + pg.id;
            nodes.push({ id: pgid, parent: did, text: 'Page ' + pgNum, state: { opened: true },
              li_attr: { class: 'page-node' },
              data: { type: 'page', page: pg, documentId: doc.id, conditionId: cond.id } });
            (pg.takeoffZones || []).forEach(function(z) {
              var zNum = getZoneNumber(z.id);
              var zid = pgid + '-zone-' + z.id;
              nodes.push({ id: zid, parent: pgid, text: 'Zone ' + zNum,
                li_attr: { class: 'zone-node' },
                data: { type: 'zone', zone: z, pageId: pg.id, documentId: doc.id, conditionId: cond.id } });
            });
          });
        });
      });
      var $tree = $('#takeoffTree');
      if ($tree.jstree(true)) {
        $tree.jstree(true).settings.core.data = nodes;
        $tree.jstree(true).refresh();
      } else {
        $tree.jstree({ core: { data: nodes, check_callback: true }, plugins: ['wholerow'] });
      }
    }

    // â”€â”€ Server calls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    function refreshProjects() {
      return api({ url: '/api/demo/projects', type: 'GET' }).done(function(ids) {
        var $s = $('#projectSelect');
        $s.empty().append($('<option/>').val('').text('-- Select Project --'));
        (ids || []).forEach(function(id) { $s.append($('<option/>').val(id).text(id)); });
      });
    }

    function loadProject(projectId) {
      if (!projectId) {
        currentProjectId = null;
        renderTree('none', []);
        setStatus('no project');
        return $.Deferred().resolve().promise();
      }
      currentProjectId = projectId;
      setStatus('loading...');
      return api({ url: '/api/demo/projects/' + projectId + '/conditions', type: 'GET' }).done(function(data) {
        // Server now handles all summary computation - just render the data as received
        renderTree(projectId, data);
        setStatus('loaded');
      }).fail(function() { setStatus('load failed'); });
    }

    function fetchCondition(condId) {
      return api({ url: '/api/demo/projects/' + currentProjectId + '/conditions/' + condId, type: 'GET' });
    }

    function putCondition(cond) {
      // Server will compute all summaries when data is saved
      return api({ url: '/api/demo/conditions/' + cond.id, type: 'PUT', contentType: 'application/json', data: JSON.stringify(cond) });
    }

    function selectTreeNode(nodeId) {
      setTimeout(function() {
        try {
          var tree = $('#takeoffTree').jstree(true);
          if (tree) {
            tree.deselect_all(true);
            tree.select_node(nodeId);
            // Scroll to the node if it's not visible
            var $node = $('#' + nodeId);
            if ($node.length) {
              $node[0].scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
          }
        } catch (e) { console.warn('select_node failed', e); }
      }, 300);
    }

    // â”€â”€ jQuery ready â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    $(function() {
      refreshProjects();

      $('#projectSelect').change(function() {
        var v = $(this).val();
        loadProject(v || null);
      });

      // Auto-select first project on startup - improved timing and error handling
      setTimeout(function() {
        try {
          var $sel = $('#projectSelect');
          var firstOption = $sel.find('option').eq(1); // Skip placeholder at index 0
          if (firstOption.length && !$sel.val()) {
            var firstProjectId = firstOption.val();
            $sel.val(firstProjectId);
            loadProject(firstProjectId);
          }
        } catch (e) {
          console.warn('Auto-select project failed:', e);
        }
      }, 200);

      // â”€â”€ Tree selection â†’ show form â”€â”€
      $('#takeoffTree').on('select_node.jstree', function(e, data) {
        var nd = data.node.data || {};
        if (nd.type === 'condition') {
          sel = { conditionId: nd.condition.id, documentId: null, pageId: null, zoneId: null };
          $('#cId').val(nd.condition.id);
          $('#cProjectId').val(nd.condition.projectId);
          var $tb = $('#cProjectSummary tbody').empty();
          (nd.condition.projectSummary || []).forEach(function(q) { $tb.append(qDisplayRow(q)); });
          showConditionForm();
        } else if (nd.type === 'document') {
          sel.conditionId = nd.conditionId;
          sel.documentId = nd.document.id;
          sel.pageId = sel.zoneId = null;
          $('#dId').val(nd.document.id);
          var $dt = $('#dSummary tbody').empty();
          (nd.document.documentSummary || []).forEach(function(q) { $dt.append(qDisplayRow(q)); });
          showDocumentForm();
        } else if (nd.type === 'page') {
          sel.conditionId = nd.conditionId;
          sel.documentId = nd.documentId;
          sel.pageId = nd.page.id;
          sel.zoneId = null;
          $('#pId').val(nd.page.id);
          $('#pNumber').val(nd.page.pageNumber);
          var $pt = $('#pSummary tbody').empty();
          (nd.page.pageSummary || []).forEach(function(q) { $pt.append(qDisplayRow(q)); });
          showPageForm();
        } else if (nd.type === 'zone') {
          sel.conditionId = nd.conditionId;
          sel.documentId = nd.documentId;
          sel.pageId = nd.pageId;
          sel.zoneId = nd.zone.id;
          $('#zId').val(nd.zone.id);
          var $zt = $('#zSummary tbody').empty();
          (nd.zone.zoneSummary || []).forEach(function(q) { $zt.append(qInputRow(q)); });
          showZoneForm();
        } else {
          sel = { conditionId: null, documentId: null, pageId: null, zoneId: null };
          hideAllForms();
        }
      });

      // â”€â”€ Add Condition â”€â”€
      $('#btnAddCondition').click(function() {
        setStatus('creating condition...');
        var projectId = $('#projectSelect').val();

        function doCreate(projId) {
          var payload = { projectId: projId, projectSummary: [], documents: [] };
          api({ url: '/api/demo/conditions', type: 'POST', contentType: 'application/json', data: JSON.stringify(payload) })
            .done(function(created) {
              setStatus('condition created');
              if ($('#projectSelect').val() !== projId) {
                $('#projectSelect').val(projId);
              }
              loadProject(projId).done(function() {
                selectTreeNode('cond-' + created.id);
              });
            })
            .fail(function() { alert('Failed to create condition'); setStatus('ready'); });
        }

        if (projectId) {
          doCreate(projectId);
        } else {
          api({ url: '/api/demo/guids', type: 'POST' }).done(function(guid) {
            var $s = $('#projectSelect');
            $s.append($('<option/>').val(guid).text(guid));
            $s.val(guid);
            currentProjectId = guid;
            doCreate(guid);
          }).fail(function() { alert('Failed to create project'); setStatus('ready'); });
        }
      });

      // â”€â”€ Delete Condition â”€â”€
      $('#cDeleteCondition').click(function() {
        var condId = $('#cId').val();
        var projId = $('#cProjectId').val();
        if (!condId || !projId) return alert('No condition selected');
        if (!confirm('Delete condition ' + condId + '?')) return;
        api({ url: '/api/demo/projects/' + projId + '/conditions/' + condId, type: 'DELETE' })
          .done(function() { setStatus('deleted'); hideAllForms(); loadProject(projId); })
          .fail(function() { alert('Failed to delete condition'); });
      });

      // â”€â”€ Add Document â”€â”€
      $('#cAddDocument').click(function() {
        var condId = sel.conditionId || $('#cId').val();
        if (!condId || !currentProjectId) return alert('No condition selected');
        api({ url: '/api/demo/guids', type: 'POST' }).done(function(docGuid) {
          fetchCondition(condId).done(function(cond) {
            cond.documents = cond.documents || [];
            cond.documents.push({ id: docGuid, documentSummary: [], pages: [] });
            // Assign number to new document immediately
            var docNum = getDocumentNumber(docGuid);
            putCondition(cond).done(function() {
              loadProject(currentProjectId).done(function() {
                selectTreeNode('cond-' + condId + '-doc-' + docGuid);
              });
            }).fail(function() { alert('Failed to add document'); });
          }).fail(function() { alert('Failed to load condition'); });
        }).fail(function() { alert('Failed to get guid'); });
      });

      // â”€â”€ Delete Document â”€â”€
      $('#dDeleteDocument').click(function() {
        if (!sel.conditionId || !sel.documentId) return alert('No document selected');
        if (!confirm('Delete document from all conditions?')) return;
        api({ url: '/api/demo/projects/' + currentProjectId + '/documents/' + sel.documentId, type: 'DELETE' })
          .done(function() {
            setStatus('document deleted from all conditions');
            hideAllForms();
            loadProject(currentProjectId);
          })
          .fail(function() { alert('Failed to delete document'); });
      });

      // â”€â”€ Add Page â”€â”€
      $('#dAddPage').click(function() {
        if (!sel.conditionId || !sel.documentId) return alert('No document selected');
        api({ url: '/api/demo/guids', type: 'POST' }).done(function(pageGuid) {
          fetchCondition(sel.conditionId).done(function(cond) {
            var doc = (cond.documents || []).find(function(d) { return d.id === sel.documentId; });
            if (!doc) return alert('Document not found');
            doc.pages = doc.pages || [];
            doc.pages.push({ id: pageGuid, pageNumber: doc.pages.length + 1, pageSummary: [], takeoffZones: [] });
            // Assign number to new page immediately
            var pgNum = getPageNumber(pageGuid);
            putCondition(cond).done(function() {
              loadProject(currentProjectId).done(function() {
                selectTreeNode('cond-' + sel.conditionId + '-doc-' + sel.documentId + '-page-' + pageGuid);
              });
            }).fail(function() { alert('Failed to add page'); });
          }).fail(function() { alert('Failed to load condition'); });
        }).fail(function() { alert('Failed to get guid'); });
      });

      // â”€â”€ Delete Page â”€â”€
      $('#pDeletePage').click(function() {
        if (!sel.conditionId || !sel.documentId || !sel.pageId) return alert('No page selected');
        if (!confirm('Delete page from all conditions?')) return;
        api({ url: '/api/demo/projects/' + currentProjectId + '/pages/' + sel.pageId, type: 'DELETE' })
          .done(function() {
            setStatus('page deleted from all conditions');
            hideAllForms();
            loadProject(currentProjectId);
          })
          .fail(function() { alert('Failed to delete page'); });
      });

      // â”€â”€ Add Zone â”€â”€
      $('#pAddZone').click(function() {
        if (!sel.conditionId || !sel.documentId || !sel.pageId) return alert('No page selected');
        api({ url: '/api/demo/guids', type: 'POST' }).done(function(zoneGuid) {
          fetchCondition(sel.conditionId).done(function(cond) {
            var doc = (cond.documents || []).find(function(d) { return d.id === sel.documentId; });
            if (!doc) return alert('Document not found');
            var page = (doc.pages || []).find(function(p) { return p.id === sel.pageId; });
            if (!page) return alert('Page not found');
            page.takeoffZones = page.takeoffZones || [];
            page.takeoffZones.push({ id: zoneGuid, zoneSummary: [] });
            // Assign number to new zone immediately
            var zNum = getZoneNumber(zoneGuid);
            putCondition(cond).done(function() {
              loadProject(currentProjectId).done(function() {
                selectTreeNode('cond-' + sel.conditionId + '-doc-' + sel.documentId + '-page-' + sel.pageId + '-zone-' + zoneGuid);
              });
            }).fail(function() { alert('Failed to add zone'); });
          }).fail(function() { alert('Failed to load condition'); });
        }).fail(function() { alert('Failed to get guid'); });
      });

      // â”€â”€ Zone: add summary row â”€â”€
      $('#zAddRow').click(function() {
        $('#zSummary tbody').append(qInputRow(null));
      });

      // â”€â”€ Zone: remove summary row â”€â”€
      $(document).on('click', '.z-remove-row', function() {
        $(this).closest('tr').remove();
      });

      // â”€â”€ Zone: save with auto-computed summaries â”€â”€
      $('#zSave').click(function() {
        if (!sel.conditionId || !sel.documentId || !sel.pageId || !sel.zoneId) return alert('No zone selected');
        var items = [];
        $('#zSummary tbody tr').each(function() {
          var name = $(this).find('.q-name').val();
          var unit = $(this).find('.q-unit').val();
          var value = parseFloat($(this).find('.q-value').val()) || 0;
          if (name) items.push({ name: name, unit: unit, value: value });
        });
        fetchCondition(sel.conditionId).done(function(cond) {
          var doc = (cond.documents || []).find(function(d) { return d.id === sel.documentId; });
          if (!doc) return alert('Document not found');
          var page = (doc.pages || []).find(function(p) { return p.id === sel.pageId; });
          if (!page) return alert('Page not found');
          var zone = (page.takeoffZones || []).find(function(z) { return z.id === sel.zoneId; });
          if (!zone) return alert('Zone not found');
          zone.zoneSummary = items;
          // putCondition will auto-compute all summaries before saving
          putCondition(cond).done(function() {
            setStatus('zone saved, summaries updated');
            loadProject(currentProjectId).done(function() {
              selectTreeNode('cond-' + sel.conditionId + '-doc-' + sel.documentId + '-page-' + sel.pageId + '-zone-' + sel.zoneId);
            });
          }).fail(function() { alert('Failed to save zone'); });
        }).fail(function() { alert('Failed to load condition'); });
      });

      // â”€â”€ Zone: delete â”€â”€
      $('#zDelete').click(function() {
        if (!sel.conditionId || !sel.documentId || !sel.pageId || !sel.zoneId) return alert('No zone selected');
        if (!confirm('Delete zone ' + sel.zoneId + '?')) return;
        api({ url: '/api/demo/projects/' + currentProjectId + '/zones/' + sel.zoneId, type: 'DELETE' })
          .done(function() {
            setStatus('zone deleted, summaries updated');
            hideAllForms();
            loadProject(currentProjectId);
          })
          .fail(function() { alert('Failed to delete zone'); });
      });

    }); // end ready
  })();
  </script>
</body>
</html>