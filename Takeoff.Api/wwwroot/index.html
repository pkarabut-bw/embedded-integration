<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/themes/default/style.min.css" rel="stylesheet" />
  <title>Takeoff</title>
  <style>
    body, html { height: 100%; }
    #formPanel { height: calc(100vh - 120px); overflow:auto }
    #takeoffTree { height: calc(100vh - 120px); overflow:auto; border:1px solid #ddd; padding:8px }
    .table td, .table th { vertical-align: middle }
  </style>
</head>
<body>
  <div class="container-fluid p-2">
    <div class="d-flex mb-2">
      <div>
        <button id="btnAddCondition" class="btn btn-primary">AddCondition</button>
        <button id="btnEditCondition" class="btn btn-secondary">EditCondition</button>
        <button id="btnDeleteCondition" class="btn btn-danger">DeleteCondition</button>
      </div>
      <div class="ms-auto d-flex align-items-center">
        <select id="projectSelect" class="form-select me-2" style="width:320px;"></select>
        <div id="statusArea" class="text-muted">Status: idle</div>
      </div>
    </div>
    <div class="row g-2">
      <div class="col-7">
        <div id="takeoffTree"></div>
      </div>
      <div class="col-5">
        <div id="formPanel" class="card p-3">
          <h5 id="formTitle">Condition</h5>
          <div class="mb-2">
            <label class="form-label">Id</label>
            <input id="fId" class="form-control" readonly />
          </div>
          <div class="mb-2">
            <label class="form-label">ProjectId</label>
            <input id="fProjectId" class="form-control" readonly />
          </div>

          <div class="mb-2">
            <h6>Measurements</h6>
            <table class="table" id="valuesTable"><thead><tr><th>Measurement Name</th><th>Units</th><th>Value</th><th></th></tr></thead><tbody></tbody></table>
            <button id="btnAddValue" class="btn btn-sm btn-outline-primary">Add Measurement</button>
          </div>

          <div class="d-flex">
            <button id="btnSave" class="btn btn-success me-2">Save</button>
            <button id="btnCancel" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/jstree.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let currentProjectId = null;
    let currentCondition = null;
    let isEditMode = false;

    function setStatus(text) { $('#statusArea').text('Status: ' + text); }

    const guidRegex = /^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;
    function isConditionNodeId(id) {
      if (!id || !id.startsWith('cond-')) return false;
      const rest = id.substring(5);
      return guidRegex.test(rest);
    }

    function resolveConditionNodeId(node) {
      if (!node) return null;
      if (isConditionNodeId(node.id)) return node.id;
      if (node.parents && node.parents.length) {
        for (const p of node.parents) {
          if (isConditionNodeId(p)) return p;
        }
      }
      return null;
    }

    function renderTree(projectId, data) {
      const nodes = [];
      const projectNodeId = 'project-' + projectId;
      nodes.push({ id: projectNodeId, parent: '#', text: 'Project: ' + projectId, state: { opened: true } });
      data.forEach(cond => {
        const condId = 'cond-' + cond.id;
        nodes.push({ id: condId, parent: projectNodeId, text: 'Condition: ' + cond.id, data: { condition: cond } });
        nodes.push({ id: condId + '-vals', parent: condId, text: 'Measurements' });
        (cond.measurements || []).forEach((v, i) => {
          const name = v?.measurementName || '';
          const safeName = encodeURIComponent(name).replace(/%/g, '');
          const nodeId = `${condId}-vals-${i}-${safeName}`;
          nodes.push({ id: nodeId, parent: condId + '-vals', text: (name || '<unnamed>') + ' (' + (v?.unitsOfMeasurements || '') + '): ' + (v?.value ?? 0) });
        });
      });
      const tree = $('#takeoffTree');
      if (tree.jstree(true)) tree.jstree(true).settings.core.data = nodes, tree.jstree(true).refresh();
      else tree.jstree({ core: { data: nodes }, plugins: ['wholerow'] });
    }

    function loadProject(projectId) {
      if (!projectId) { currentProjectId = null; renderTree('none', []); return setStatus('no project selected'); }
      currentProjectId = projectId;
      setStatus('loading');
      $.getJSON('/api/demo/projects/' + projectId + '/conditions')
        .done(function(data) { renderTree(projectId, data); setStatus('loaded'); })
        .fail(function() { setStatus('load failed'); alert('Failed to load conditions'); });
    }

    function refreshProjects() {
      $.getJSON('/api/demo/projects').done(function(ids){
        const $sel = $('#projectSelect');
        $sel.empty();
        $sel.append($('<option/>').val('').text('Not selected'));
        ids.forEach(id => $sel.append($('<option/>').val(id).text(id)));
        if (currentProjectId) $sel.val(currentProjectId);
      }).fail(function(){ setStatus('failed to load projects'); });
    }

    function clearForm() {
      $('#fId').val('');
      $('#fProjectId').val(currentProjectId || '');
      $('#valuesTable tbody').empty();
      currentCondition = null;
      isEditMode = false;
      $('#formTitle').text('Create Condition');
    }

    function populateForm(condition) {
      currentCondition = condition;
      $('#fId').val(condition.id);
      $('#fProjectId').val(condition.projectId);
      $('#valuesTable tbody').empty();
      (condition.measurements || []).forEach(v => addValueRow(v));
      isEditMode = true;
      $('#formTitle').text('Edit Condition');
    }

    function addValueRow(val) {
      const name = val?.measurementName || '';
      const units = val?.unitsOfMeasurements || '';
      const value = val?.value ?? 0;
      const $tr = $(`<tr>
        <td><input class="form-control valueName" value="${name}" /></td>
        <td><input class="form-control valueUnits" value="${units}" /></td>
        <td><input type="number" step="any" class="form-control valueNumber" value="${value}" /></td>
        <td><button class="btn btn-sm btn-danger btnRemoveValue">Remove</button></td>
      </tr>`);
      $('#valuesTable tbody').append($tr);
    }

    function gatherForm() {
      const id = $('#fId').val();
      const projectId = $('#fProjectId').val();
      const measurements = [];
      $('#valuesTable tbody tr').each(function(){
        const name = $(this).find('.valueName').val();
        const units = $(this).find('.valueUnits').val();
        const val = parseFloat($(this).find('.valueNumber').val()) || 0;
        if (name) measurements.push({ measurementName: name, unitsOfMeasurements: units, value: val });
      });
      return { id: id, projectId: projectId, measurements: measurements };
    }

    function fetchAndPopulateFromNodeId(nodeId) {
      if (!nodeId || !nodeId.startsWith('cond-')) return;
      const condId = nodeId.replace('cond-','');
      const projectId = currentProjectId;
      if (!projectId) { alert('ProjectId required'); return; }
      setStatus('loading condition');
      $.getJSON('/api/demo/projects/' + projectId + '/conditions/' + condId)
        .done(function(cond){ populateForm(cond); setStatus('condition loaded'); })
        .fail(function(){ setStatus('load condition failed'); alert('Failed to load condition from server'); });
    }

    $(function(){
      refreshProjects();

      $('#projectSelect').change(function(){
        const val = $(this).val();
        if (!val) { loadProject(null); } else { loadProject(val); }
      });

      $('#takeoffTree').on('select_node.jstree', function(e, data){
        const node = data.node;
        if (!node) return;
        const condNodeId = resolveConditionNodeId(node);
        if (condNodeId) fetchAndPopulateFromNodeId(condNodeId);
      });

      $('#btnAddCondition').click(function(){
        $.post('/api/demo/guids').done(function(condGuid){
          clearForm();
          $('#fId').val(condGuid);
          const sel = $('#projectSelect').val();
          if (sel) {
            $('#fProjectId').val(sel);
            addValueRow({ measurementName: '', unitsOfMeasurements: '', value: 0 });
          } else {
            $.post('/api/demo/guids').done(function(projGuid){
              const $sel = $('#projectSelect');
              $sel.append($('<option/>').val(projGuid).text(projGuid));
              $sel.val(projGuid);
              $('#fProjectId').val(projGuid);
              loadProject(projGuid);
              addValueRow({ measurementName: '', unitsOfMeasurements: '', value: 0 });
            }).fail(function(){ alert('Failed to get project guid'); });
          }
        }).fail(function(){ alert('Failed to get guid'); });
      });

      $('#btnEditCondition').click(function(){
        const sel = $('#takeoffTree').jstree('get_selected');
        if (!sel || !sel.length) return alert('Select a condition node');
        let nodeId = sel[0];
        const tree = $('#takeoffTree').jstree(true);
        const node = tree.get_node(nodeId);
        const condNodeId = resolveConditionNodeId(node);
        if (!condNodeId) return alert('Select a condition node');
        fetchAndPopulateFromNodeId(condNodeId);
      });

      $('#btnDeleteCondition').click(function(){
        const sel = $('#takeoffTree').jstree('get_selected');
        if (!sel || !sel.length) return alert('Select a condition node');
        let nodeId = sel[0];
        const tree = $('#takeoffTree').jstree(true);
        const node = tree.get_node(nodeId);
        const condNodeId = resolveConditionNodeId(node);
        if (!condNodeId) return alert('Select a condition node');
        const condId = condNodeId.replace('cond-','');
        const projectId = currentProjectId;
        if (!projectId) return alert('ProjectId required');
        setStatus('deleting');
        $.ajax({ url: '/api/demo/projects/' + projectId + '/conditions/' + condId, method: 'DELETE' })
          .done(function(){ setStatus('deleted'); loadProject(projectId); refreshProjects(); })
          .fail(function(){ setStatus('delete failed'); alert('Delete failed'); });
      });

      $('#btnAddValue').click(function(){ addValueRow({ measurementName: '', unitsOfMeasurements: '', value: 0 }); });

      $('#valuesTable').on('click', '.btnRemoveValue', function(){ $(this).closest('tr').remove(); });

      $('#btnCancel').click(function(){ clearForm(); });

      $('#btnSave').click(function(){
        const model = gatherForm();
        if (!model.projectId) return alert('ProjectId required');
        if (!model.id) return alert('Id required');
        setStatus('saving');
        const url = '/api/demo/conditions' + (isEditMode ? ('/' + model.id) : '');
        const method = isEditMode ? 'PUT' : 'POST';
        $.ajax({ url: url, method: method, contentType: 'application/json', data: JSON.stringify(model) })
          .done(function(){ setStatus('saved'); loadProject(model.projectId); refreshProjects(); clearForm(); })
          .fail(function(){ setStatus('save failed'); alert('Save failed'); });
      });

      // initial state
      clearForm();
      setStatus('ready');
    });
  </script>
</body>
</html>