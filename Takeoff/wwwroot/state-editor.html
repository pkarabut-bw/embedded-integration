<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Takeoff State Editor</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .header { display: flex; align-items: center; justify-content: flex-start; gap: 12px; }
    .tabs { margin-bottom: 12px; }
    .tab-btn { padding: 8px 12px; margin-right: 6px; cursor: pointer; border: 1px solid #ccc; background: #f7f7f7; }
    .tab-btn.active { background: #e0e0e0; }
    .tab { display: none; }
    .tab.active { display: block; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; }
    th { background: #eee; }
    input[type="text"], input[type="number"] { width: 100%; }
    .controls { margin-top: 10px; }
    button { margin-right: 8px; }
    .section-header { display:flex; align-items:center; justify-content:flex-start; gap:8px; margin-bottom:8px; }

    /* Modal styles */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal { background: white; padding: 16px; border-radius: 4px; width: 600px; max-width: 95%; }
    .modal h3 { margin-top: 0; }
    .modal .row { display: flex; gap: 8px; margin-bottom: 8px; }
    .modal label { width: 140px; font-weight: bold; }
    .modal input { flex: 1; padding: 6px; }
    .modal .actions { text-align: right; margin-top: 12px; }

    /* Error modal specific */
    .error-content { white-space: pre-wrap; max-height: 60vh; overflow: auto; }
  </style>
</head>
<body>
  <div class="header" style="margin-bottom:7px">
    <h1>Takeoff State Editor</h1>
    <button id="reset">Reset to Default</button>
  </div>

  <div class="tabs" style="margin-bottom:50px">
    <button id="tabQuant" class="tab-btn active">Quantities</button>
    <button id="tabMeas" class="tab-btn">Measurements</button>
  </div>

  <div id="quantTab" class="tab active">
    <div class="section-header"><h2 style="margin:0">Quantities</h2><button id="addQty">Add Quantity</button></div>
    <table id="quantTable">
      <thead><tr><th>Id</th><th>Name</th><th>Uom</th><th>ConditionId</th><th>Value</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="measTab" class="tab">
    <div class="section-header"><h2 style="margin:0">Measurements</h2><button id="addMeas">Add Measurement</button></div>
    <table id="measTable">
      <thead><tr><th>Index</th><th>MeasurementType</th><th>ConditionType</th><th>Uom</th><th>ConditionId</th><th>Value</th><th>Actions</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <!-- Modal overlay for editors -->
  <div id="modalOverlay" class="modal-overlay">
    <div class="modal" id="modal">
      <h3 id="modalTitle">Edit</h3>
      <div id="modalContent"></div>
      <div class="actions">
        <button id="modalSave">Save</button>
        <button id="modalCancel">Cancel</button>
      </div>
    </div>
  </div>

  <!-- Error modal overlay -->
  <div id="errorOverlay" class="modal-overlay">
    <div class="modal" style="max-width:700px">
      <h3>Validation / Error</h3>
      <div id="errorContent" class="error-content"></div>
      <div class="actions">
        <button id="errorClose">Close</button>
      </div>
    </div>
  </div>

  <script>
    let currentEdit = null; // { type: 'quantity'|'measurement', id or index, mode: 'add'|'edit' }
    let availableConditionIds = []; // populated from current state during render()

    function showError(msg) {
      const el = document.getElementById('errorContent');
      if (Array.isArray(msg)) {
        el.textContent = msg.join('\n');
      } else {
        el.textContent = String(msg);
      }
      document.getElementById('errorOverlay').style.display = 'flex';
    }
    document.getElementById('errorClose').addEventListener('click', () => { document.getElementById('errorOverlay').style.display = 'none'; });

    async function fetchState() {
      const res = await fetch('/State');
      return res.ok ? await res.json() : null;
    }

    function rowCell(text) { const td = document.createElement('td'); td.textContent = text; return td; }

    function openModal(title, contentHtml) {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalContent').innerHTML = contentHtml;
      document.getElementById('modalOverlay').style.display = 'flex';
      // focus first input
      const firstInput = document.querySelector('#modalContent input');
      if (firstInput) firstInput.focus();
      // setup condition controls if present
      setupConditionControls();
    }

    function closeModal() {
      document.getElementById('modalOverlay').style.display = 'none';
      currentEdit = null;
    }

    function buildConditionSelectorHtml(selected) {
      // selected is string or Guid
      const opts = availableConditionIds.map(id => `<option value="${id}">${id}</option>`).join('');
      return `
        <div class="row">
          <label>ConditionId</label>
          <div style="flex:1; display:flex; gap:8px;">
            <select id="f_condition_select" style="flex:1">${opts}</select>
            <button id="f_generate_condition">Generate new</button>
          </div>
        </div>
        <div class="row"><label></label><input id="f_condition" type="text" readonly value="${selected || ''}"></div>
      `;
    }

    function quantityFormHtml(q) {
      const id = q?.Id || q?.id || '';
      const name = q?.Name || q?.name || '';
      const uom = q?.Uom || q?.uom || '';
      const cond = (q?.ConditionId || q?.conditionId || '');
      const value = (q?.Value ?? q?.value ?? '');
      return `
        <div class="row"><label>Id</label><input id="f_id" type="text" value="${id}" readonly></div>
        <div class="row"><label>Name</label><input id="f_name" type="text" value="${escapeHtml(name)}"></div>
        <div class="row"><label>Uom</label><input id="f_uom" type="text" value="${escapeHtml(uom)}"></div>
        ${buildConditionSelectorHtml(cond)}
        <div class="row"><label>Value</label><input id="f_value" type="number" step="any" value="${value}"></div>
      `;
    }

    function measurementFormHtml(m) {
      const mt = m?.MeasurementType || m?.measurementType || '';
      const ct = m?.ConditionType || m?.conditionType || '';
      const uom = m?.Uom || m?.uom || '';
      const cond = (m?.ConditionId || m?.conditionId || '');
      const value = (m?.Value ?? m?.value ?? '');
      return `
        <div class="row"><label>MeasurementType</label><input id="f_mt" type="text" value="${escapeHtml(mt)}"></div>
        <div class="row"><label>ConditionType</label><input id="f_ct" type="text" value="${escapeHtml(ct)}"></div>
        <div class="row"><label>Uom</label><input id="f_uom" type="text" value="${escapeHtml(uom)}"></div>
        ${buildConditionSelectorHtml(cond)}
        <div class="row"><label>Value</label><input id="f_value" type="number" step="any" value="${value}"></div>
      `;
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    async function render() {
      const state = await fetchState();
      const qBody = document.querySelector('#quantTable tbody'); qBody.innerHTML = '';
      const mBody = document.querySelector('#measTable tbody'); mBody.innerHTML = '';
      if (!state) return;

      const quantities = state.quantities || state.Quantities || [];
      const measurements = state.measurements || state.Measurements || [];

      // build unique condition ids
      const conds = [];
      (quantities || []).forEach(q => { const id = q?.conditionId || q?.ConditionId; if (id && !conds.includes(String(id))) conds.push(String(id)); });
      (measurements || []).forEach(m => { const id = m?.conditionId || m?.ConditionId; if (id && !conds.includes(String(id))) conds.push(String(id)); });
      availableConditionIds = conds;

      quantities.forEach(q => {
        const tr = document.createElement('tr');
        tr.appendChild(rowCell(q.id || q.Id));
        tr.appendChild(rowCell(q.name || q.Name));
        tr.appendChild(rowCell(q.uom || q.Uom));
        tr.appendChild(rowCell(q.conditionId || q.ConditionId));
        tr.appendChild(rowCell(q.value || q.Value));
        const actions = document.createElement('td');
        const edit = document.createElement('button'); edit.textContent = 'Edit'; edit.onclick = () => openQuantityEditor(q);
        const del = document.createElement('button'); del.textContent = 'Delete'; del.onclick = () => deleteQuantity(q.id || q.Id);
        actions.appendChild(edit); actions.appendChild(del);
        tr.appendChild(actions);
        qBody.appendChild(tr);
      });

      measurements.forEach((m, idx) => {
        const tr = document.createElement('tr');
        tr.appendChild(rowCell(idx));
        tr.appendChild(rowCell(m.measurementType || m.MeasurementType));
        tr.appendChild(rowCell(m.conditionType || m.ConditionType));
        tr.appendChild(rowCell(m.uom || m.Uom));
        tr.appendChild(rowCell(m.conditionId || m.ConditionId));
        tr.appendChild(rowCell(m.value || m.Value));
        const actions = document.createElement('td');
        const edit = document.createElement('button'); edit.textContent = 'Edit'; edit.onclick = () => openMeasurementEditor(idx, m);
        const del = document.createElement('button'); del.textContent = 'Delete'; del.onclick = () => deleteMeasurement(idx);
        actions.appendChild(edit); actions.appendChild(del);
        tr.appendChild(actions);
        mBody.appendChild(tr);
      });
    }

    // Attach handlers for selector/generate controls inside modal
    function setupConditionControls() {
      const sel = document.getElementById('f_condition_select');
      const input = document.getElementById('f_condition');
      const genBtn = document.getElementById('f_generate_condition');
      if (!sel || !input || !genBtn) return;
      // populate select (in case availableConditionIds changed)
      sel.innerHTML = availableConditionIds.map(id => `<option value="${escapeHtml(id)}">${escapeHtml(id)}</option>`).join('');
      // set select to current input if present
      if (input.value) {
        const options = Array.from(sel.options).map(o => o.value);
        if (options.includes(input.value)) {
          sel.value = input.value;
        } else {
          // prepend custom/current value
          sel.insertAdjacentHTML('afterbegin', `<option value="${escapeHtml(input.value)}">${escapeHtml(input.value)}</option>`);
          sel.value = input.value;
        }
      }
      sel.addEventListener('change', () => {
        input.value = sel.value;
      });
      genBtn.addEventListener('click', async () => {
        genBtn.disabled = true;
        try {
          const res = await fetch('/State/condition/new');
          if (!res.ok) { const txt = await res.text(); showError(txt); return; }
          const guid = await res.text();
          // server returns plain guid; normalize
          const newId = guid.replace(/"/g, '').trim();
          // set input and add to select
          input.value = newId;
          const exists = Array.from(sel.options).some(o => o.value === newId);
          if (!exists) {
            sel.insertAdjacentHTML('beforeend', `<option value="${escapeHtml(newId)}">${escapeHtml(newId)}</option>`);
          }
          sel.value = newId;
        } finally {
          genBtn.disabled = false;
        }
      });
    }

    // Open editors
    function openQuantityEditor(q) {
      currentEdit = { type: 'quantity', mode: 'edit', id: q.Id || q.id };
      openModal('Edit Quantity', quantityFormHtml(q));
    }

    function openMeasurementEditor(idx, m) {
      currentEdit = { type: 'measurement', mode: 'edit', index: idx };
      openModal('Edit Measurement', measurementFormHtml(m));
    }

    // Modal save handler
    document.getElementById('modalSave').addEventListener('click', async () => {
      if (!currentEdit) return closeModal();
      if (currentEdit.type === 'quantity') {
        const payload = {
          Id: document.getElementById('f_id').value,
          Name: document.getElementById('f_name').value,
          Uom: document.getElementById('f_uom').value,
          ConditionId: document.getElementById('f_condition').value,
          Value: parseFloat(document.getElementById('f_value').value)
        };
        let res;
        if (currentEdit.mode === 'add') {
          res = await fetch('/State/quantities', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        } else {
          res = await fetch('/State/quantities', { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }
        if (!res.ok) { const txt = await res.text(); showError(txt); return; }
        closeModal();
        await render();
      } else if (currentEdit.type === 'measurement') {
        const payload = {
          MeasurementType: document.getElementById('f_mt').value,
          ConditionType: document.getElementById('f_ct').value,
          Uom: document.getElementById('f_uom').value,
          ConditionId: document.getElementById('f_condition').value,
          Value: parseFloat(document.getElementById('f_value').value)
        };
        let res;
        if (currentEdit.mode === 'add') {
          res = await fetch('/State/measurements', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        } else {
          const index = currentEdit.index;
          res = await fetch('/State/measurements/' + index, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
        }
        if (!res.ok) { const txt = await res.text(); showError(txt); return; }
        closeModal();
        await render();
      }
    });

    document.getElementById('modalCancel').addEventListener('click', () => { closeModal(); });

    async function addQuantity() {
      const q = {
        Id: crypto.randomUUID(),
        Name: '',
        Uom: '',
        ConditionId: crypto.randomUUID(),
        Value: 0
      };
      currentEdit = { type: 'quantity', mode: 'add' };
      openModal('Add Quantity', quantityFormHtml(q));
    }

    async function deleteQuantity(id) {
      if (!confirm('Delete quantity?')) return;
      const res = await fetch('/State/quantities/' + id, { method: 'DELETE' });
      if (!res.ok) { const txt = await res.text(); showError(txt); }
      await render();
    }

    async function addMeasurement() {
      const m = {
        MeasurementType: '',
        ConditionType: '',
        Uom: '',
        ConditionId: crypto.randomUUID(),
        Value: 0
      };
      currentEdit = { type: 'measurement', mode: 'add' };
      openModal('Add Measurement', measurementFormHtml(m));
    }

    async function deleteMeasurement(idx) {
      if (!confirm('Delete measurement?')) return;
      const res = await fetch('/State/measurements/' + idx, { method: 'DELETE' });
      if (!res.ok) { const txt = await res.text(); showError(txt); }
      await render();
    }

    document.getElementById('addQty').addEventListener('click', addQuantity);
    document.getElementById('addMeas').addEventListener('click', addMeasurement);
    document.getElementById('reset').addEventListener('click', async () => { const r = await fetch('/State/reset', { method: 'POST' }); if (!r.ok) { const txt = await r.text(); showError(txt); } await render(); });

    // Tabs handling
    const tabQuant = document.getElementById('tabQuant');
    const tabMeas = document.getElementById('tabMeas');
    const quantTab = document.getElementById('quantTab');
    const measTab = document.getElementById('measTab');

    tabQuant.addEventListener('click', () => {
      tabQuant.classList.add('active');
      tabMeas.classList.remove('active');
      quantTab.classList.add('active');
      measTab.classList.remove('active');
    });
    tabMeas.addEventListener('click', () => {
      tabMeas.classList.add('active');
      tabQuant.classList.remove('active');
      measTab.classList.add('active');
      quantTab.classList.remove('active');
    });

    render();
  </script>
</body>
</html>