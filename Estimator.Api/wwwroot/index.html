<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/themes/default/style.min.css" rel="stylesheet" />
  <title>Estimator</title>
  <style>
    #estimatorTree { height: calc(100vh - 120px); overflow:auto; border:1px solid #ddd; padding:8px }
  </style>
</head>
<body>
  <div class="container-fluid p-2">
    <div class="d-flex mb-2">
      <div>
        <button id="btnPullSnapshot" class="btn btn-primary">Get All Conditions from Takeoff</button>
      </div>
      <div class="ms-auto d-flex align-items-center">
        <select id="projectSelect" class="form-select me-2" style="width:300px;"></select>
        <div id="statusBanner" class="text-muted">Idle</div>
      </div>
    </div>
    <div id="estimatorTree"></div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jstree@3.3.16/dist/jstree.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    function setStatus(text) { $('#statusBanner').text(text); }

    function renderTree(projectId, data) {
      const nodes = [];
      const projectNodeId = 'project-' + projectId;
      nodes.push({ id: projectNodeId, parent: '#', text: 'Project: ' + projectId, state: { opened: true } });
      data.forEach((cond, condIndex) => {
        const condId = 'cond-' + cond.id;
        nodes.push({ id: condId, parent: projectNodeId, text: 'Condition: ' + cond.id, data: { condition: cond } });

        // MeasurementValues node
        const valsNodeId = condId + '-vals';
        nodes.push({ id: valsNodeId, parent: condId, text: 'Measurements' });

        (cond.measurements || []).forEach((v, i) => {
          const name = v?.measurementName || '';
          const units = v?.unitsOfMeasurements || '';
          const val = (v && typeof v.value !== 'undefined') ? v.value : 0;
          // create a stable node id using condition id + index + encoded name
          const safeName = encodeURIComponent(name || '').replace(/%/g, '');
          const nodeId = `${valsNodeId}-${i}-${safeName}`;
          const displayText = (name || '<unnamed>') + (units ? ' (' + units + ')' : '') + ': ' + val;
          nodes.push({ id: nodeId, parent: valsNodeId, text: displayText });
        });
      });
      const tree = $('#estimatorTree');
      if (tree.jstree(true)) tree.jstree(true).settings.core.data = nodes, tree.jstree(true).refresh();
      else tree.jstree({ core: { data: nodes }, plugins: ['wholerow'] });
    }

    function refreshProjects(selectedId) {
      $.getJSON('/api/demo/projects').done(function(ids){
        const $sel = $('#projectSelect');
        const prev = $sel.val();
        $sel.empty();
        $sel.append($('<option/>').val('').text('Not selected'));
        ids.forEach(id => $sel.append($('<option/>').val(id).text(id)));
        // restore selection: prefer explicit selectedId, else previous selection if still present
        if (selectedId) {
          $sel.val(selectedId);
        } else if (prev && $sel.find('option[value="'+prev+'"]').length) {
          $sel.val(prev);
        } else {
          $sel.val('');
        }
      }).fail(function(){ setStatus('failed to load projects'); });
    }

    function loadLocal(projectId) {
      if (!projectId) { renderTree('none', []); setStatus('no project selected'); return; }
      setStatus('loading local');
      $.getJSON('/api/demo/projects/' + projectId + '/conditions')
        .done(function(data){ renderTree(projectId, data); setStatus('loaded local at ' + new Date().toLocaleTimeString()); })
        .fail(function(){ setStatus('load failed'); alert('Failed to load local data'); });
    }

    $(function(){
      refreshProjects();

      $('#projectSelect').change(function(){
        const val = $(this).val();
        if (!val) { loadLocal(null); } else { loadLocal(val); }
      });

      function doPull(projectId) {
        setStatus('pulling...');
        $.ajax({ url: '/api/interactions/snapshot/pull', method: 'POST', contentType: 'application/json', data: JSON.stringify({ projectId: projectId }) })
          .done(function(data){ renderTree(projectId, data); setStatus('pulled at ' + new Date().toLocaleTimeString()); refreshProjects(projectId); })
          .fail(function(){ setStatus('pull failed'); alert('Failed to pull snapshot'); });
      }

      $('#btnPullSnapshot').click(function(){
        let projectId = $('#projectSelect').val();
        if (!projectId) {
          // prompt user to enter or generate project id
          const input = prompt('ProjectId not selected. Enter a project id or leave empty to generate a new one:');
          if (input === null) return; // user cancelled
          if (!input) {
            // generate new project id from server
            $.post('/api/demo/guids').done(function(guid){
              // add to dropdown and select
              const $sel = $('#projectSelect');
              $sel.append($('<option/>').val(guid).text(guid));
              $sel.val(guid);
              doPull(guid);
            }).fail(function(){ alert('Failed to generate project id'); });
          } else {
            // use provided id
            const $sel = $('#projectSelect');
            // add if not present
            if ($sel.find('option[value="'+input+'"]').length === 0) $sel.append($('<option/>').val(input).text(input));
            $sel.val(input);
            doPull(input);
          }
        } else {
          doPull(projectId);
        }
      });

      setStatus('ready');
    });
  </script>
</body>
</html>